# Documenta√ß√£o do Sistema de Lojas - TurattiMT

## √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Evolu√ß√£o do Sistema](#evolu√ß√£o-do-sistema)
3. [Estrutura do Banco de Dados](#estrutura-do-banco-de-dados)
4. [Arquivos Implementados](#arquivos-implementados)
5. [Funcionalidades](#funcionalidades)
6. [Tecnologias Utilizadas](#tecnologias-utilizadas)
7. [Endpoints e APIs](#endpoints-e-apis)
8. [Componentes](#componentes)
9. [Valida√ß√µes](#valida√ß√µes)
10. [Estrutura de Uploads](#estrutura-de-uploads)

## Vis√£o Geral

Sistema completo de gerenciamento de lojas desenvolvido com Next.js 15.3.3 e Supabase, incluindo m√∫ltiplos telefones e galeria de imagens com upload real.

## Evolu√ß√£o do Sistema

### Fase 1: Sistema B√°sico

- Campo √∫nico de telefone (VARCHAR)
- Campos b√°sicos de loja (nome, endere√ßo, etc.)
- Interface simples de listagem

### Fase 2: M√∫ltiplos Telefones

- Migration para transformar `telefone` em `telefones` (JSONB)
- Suporte a at√© 5 telefones por loja
- Formata√ß√£o autom√°tica de n√∫meros

### Fase 3: Sistema de Imagens com URLs

- Adi√ß√£o de 10 campos de imagem
- Sistema de imagem principal
- Interface com campos de URL

### Fase 4: Sistema de Upload Real

- Implementa√ß√£o de upload de arquivos
- Componente dedicado para upload
- Valida√ß√µes de tipo e tamanho
- Sistema de preview e gerenciamento

## Estrutura do Banco de Dados

### Tabela: `lojas`

```sql
-- Campos b√°sicos
id                     BIGINT PRIMARY KEY
nome                   VARCHAR(200) NOT NULL
endereco               VARCHAR(500)
bairro                 VARCHAR(100)
cidade                 VARCHAR(100)
estado                 VARCHAR(2)
cep                    VARCHAR(10)
descricao              TEXT
ativo                  BOOLEAN DEFAULT true
created_at             TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())
updated_at             TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now())

-- M√∫ltiplos telefones
telefones              JSONB DEFAULT '[]'::jsonb

-- Sistema de imagens
imagem_principal       VARCHAR(500)
imagem_2               VARCHAR(500)
imagem_3               VARCHAR(500)
imagem_4               VARCHAR(500)
imagem_5               VARCHAR(500)
imagem_6               VARCHAR(500)
imagem_7               VARCHAR(500)
imagem_8               VARCHAR(500)
imagem_9               VARCHAR(500)
imagem_10              VARCHAR(500)
imagem_principal_index INTEGER DEFAULT 0
```

### Migration Aplicada

```sql
-- Removido campo antigo
ALTER TABLE lojas DROP COLUMN IF EXISTS telefone;

-- Adicionado campo de telefones m√∫ltiplos
ALTER TABLE lojas ADD COLUMN telefones JSONB DEFAULT '[]'::jsonb;

-- Adicionados campos de imagens
ALTER TABLE lojas ADD COLUMN imagem_principal VARCHAR(500);
ALTER TABLE lojas ADD COLUMN imagem_2 VARCHAR(500);
-- ... at√© imagem_10

-- Adicionado √≠ndice da imagem principal
ALTER TABLE lojas ADD COLUMN imagem_principal_index INTEGER DEFAULT 0;
```

## Arquivos Implementados

### 1. API de Upload

**Arquivo**: `app/api/upload/route.ts`

- Endpoint POST para upload de imagens
- Valida√ß√µes de tipo e tamanho
- Gera√ß√£o de nomes √∫nicos
- Cria√ß√£o autom√°tica de diret√≥rios

### 2. Componente de Upload

**Arquivo**: `components/ImageUpload.tsx`

- Interface para sele√ß√£o e upload de imagens
- Preview de imagens
- Bot√µes de a√ß√£o (definir como principal, remover)
- Estados de loading e erro

### 3. P√°gina de Listagem

**Arquivo**: `app/admin/lojas/page.tsx`

- Grid responsivo de lojas
- Sistema de busca integrado
- Preview de imagem principal
- Contador de imagens
- Lista de m√∫ltiplos telefones

### 4. P√°gina de Cria√ß√£o

**Arquivo**: `app/admin/lojas/nova/page.tsx`

- Formul√°rio completo de cadastro
- Gerenciamento de m√∫ltiplos telefones
- Sistema de upload de imagens
- Valida√ß√µes em tempo real

### 5. P√°gina de Edi√ß√£o

**Arquivo**: `app/admin/lojas/[id]/editar/page.tsx`

- Carregamento de dados existentes
- Preserva√ß√£o de telefones e imagens
- Detec√ß√£o de altera√ß√µes
- Sistema de atualiza√ß√£o

## Funcionalidades

### Gerenciamento de Telefones

```typescript
// Estrutura de dados
telefones: string[] // M√°ximo 5 telefones

// Funcionalidades
- Adicionar telefone (at√© 5)
- Remover telefone (m√≠nimo 1)
- Formata√ß√£o autom√°tica
- Valida√ß√£o de formato brasileiro
```

### Sistema de Imagens

```typescript
// Estrutura de dados
imagens: string[] // 10 posi√ß√µes
imagem_principal_index: number // √çndice da imagem principal

// Funcionalidades
- Upload de arquivos PNG/JPG
- M√°ximo 5MB por arquivo
- Preview autom√°tico
- Defini√ß√£o de imagem principal
- Remo√ß√£o individual
```

### Interface de Listagem

- **Cards Responsivos**: Grid adapt√°vel (1/2/3 colunas)
- **Preview de Imagem**: √Årea dedicada 192px altura
- **Contador de Imagens**: Badge "X/10" no canto superior
- **M√∫ltiplos Telefones**: Lista vertical formatada
- **Sistema de Busca**: Pesquisa em nome e telefones
- **A√ß√µes**: Editar e excluir por loja

### Formul√°rios

- **Valida√ß√£o em Tempo Real**: Feedback imediato
- **Estados de Loading**: Indicadores visuais
- **Mensagens de Erro**: Toasts informativos
- **Preserva√ß√£o de Dados**: Manuten√ß√£o de estado
- **Responsividade**: Layout adapt√°vel

## Tecnologias Utilizadas

### Frontend

- **Next.js 15.3.3**: Framework React com Turbopack
- **TypeScript**: Tipagem est√°tica
- **Tailwind CSS**: Framework de estilos
- **Heroicons**: Biblioteca de √≠cones
- **React Hook Form**: Gerenciamento de formul√°rios (impl√≠cito)

### Backend

- **Supabase**: Banco PostgreSQL
- **Next.js API Routes**: Endpoints serverless
- **Node.js**: Runtime do servidor

### Upload e Armazenamento

- **Sistema de Arquivos**: Armazenamento local
- **FormData**: Upload de arquivos
- **Valida√ß√£o de MIME Types**: Seguran√ßa de arquivos

## Endpoints e APIs

### Upload de Imagens

```typescript
POST /api/upload
Content-Type: multipart/form-data

// Par√¢metros
file: File // Arquivo de imagem

// Valida√ß√µes
- Tipo: image/*
- Tamanho: M√°ximo 5MB

// Retorno
{
  success: true,
  url: "/uploads/lojas/loja_timestamp.ext"
}
```

### CRUD de Lojas

```typescript
// Supabase Client Integration
- Listagem: supabase.from('lojas').select('*')
- Cria√ß√£o: supabase.from('lojas').insert(dados)
- Atualiza√ß√£o: supabase.from('lojas').update(dados).eq('id', id)
- Exclus√£o: supabase.from('lojas').delete().eq('id', id)
```

## Componentes

### ImageUpload

```typescript
interface ImageUploadProps {
  value: string; // URL da imagem atual
  onChange: (url: string) => void; // Callback de mudan√ßa
  onSetAsPrincipal?: () => void; // Callback para definir como principal
  isPrincipal?: boolean; // Se √© a imagem principal
  index: number; // √çndice da imagem (1-10)
  disabled?: boolean; // Estado desabilitado
}
```

**Funcionalidades**:

- √Årea clic√°vel para sele√ß√£o
- Preview da imagem selecionada
- Bot√£o de remo√ß√£o (hover)
- Bot√£o "Definir como principal"
- Estados de loading
- Valida√ß√µes visuais

### Formul√°rios de Loja

**Estados Principais**:

```typescript
const [nome, setNome] = useState("");
const [endereco, setEndereco] = useState("");
const [telefones, setTelefones] = useState<string[]>([""]);
const [imagens, setImagens] = useState<string[]>(Array(10).fill(""));
const [imagemPrincipalIndex, setImagemPrincipalIndex] = useState(0);
const [loading, setLoading] = useState(false);
```

## Valida√ß√µes

### Frontend

```typescript
// Telefones
- M√≠nimo: 1 telefone
- M√°ximo: 5 telefones
- Formato: (99) 99999-9999 ou (99) 9999-9999

// Imagens
- Tipos aceitos: image/*
- Tamanho m√°ximo: 5MB
- Formatos recomendados: PNG, JPG, JPEG

// Campos obrigat√≥rios
- Nome da loja (m√≠nimo 2 caracteres)
- Pelo menos 1 telefone v√°lido
```

### Backend

```typescript
// Upload API
- Verifica√ß√£o de tipo MIME
- Limite de tamanho (5MB)
- Sanitiza√ß√£o de nome de arquivo
- Cria√ß√£o de diret√≥rio seguro
```

## Estrutura de Uploads

### Diret√≥rio de Imagens

```
public/
‚îî‚îÄ‚îÄ uploads/
    ‚îî‚îÄ‚îÄ lojas/
        ‚îú‚îÄ‚îÄ loja_1704067200000.jpg
        ‚îú‚îÄ‚îÄ loja_1704067300000.png
        ‚îî‚îÄ‚îÄ ...
```

### Nomenclatura de Arquivos

```typescript
// Padr√£o: loja_[timestamp].[extens√£o]
const fileName = `loja_${Date.now()}.${extension}`;

// Exemplo
("loja_1704067200000.jpg");
```

### URLs Geradas

```typescript
// Padr√£o local
"/uploads/lojas/nome_do_arquivo.ext";

// Exemplo completo
"http://localhost:3000/uploads/lojas/loja_1704067200000.jpg";
```

## Fluxo de Opera√ß√µes

### Cria√ß√£o de Loja

1. Usu√°rio acessa `/admin/lojas/nova`
2. Preenche dados b√°sicos
3. Adiciona telefones (formata√ß√£o autom√°tica)
4. Faz upload de imagens via `ImageUpload`
5. Define imagem principal
6. Submete formul√°rio
7. Dados salvos no Supabase
8. Redirecionamento para listagem

### Edi√ß√£o de Loja

1. Usu√°rio acessa `/admin/lojas/[id]/editar`
2. Sistema carrega dados existentes
3. Popula telefones e imagens
4. Usu√°rio modifica dados necess√°rios
5. Sistema detecta altera√ß√µes
6. Atualiza√ß√£o no Supabase
7. Feedback de sucesso

### Upload de Imagem

1. Usu√°rio clica na √°rea de upload
2. Seleciona arquivo do dispositivo
3. Valida√ß√µes frontend (tipo/tamanho)
4. Upload via FormData para `/api/upload`
5. Valida√ß√µes backend
6. Arquivo salvo em `public/uploads/lojas/`
7. URL retornada e atualizada no estado
8. Preview exibido na interface

## Status do Projeto

### ‚úÖ Funcionalidades Implementadas

- [x] CRUD completo de lojas
- [x] M√∫ltiplos telefones (at√© 5)
- [x] Upload real de imagens (at√© 10)
- [x] Sistema de imagem principal
- [x] Interface responsiva moderna
- [x] Valida√ß√µes frontend e backend
- [x] Sistema de busca integrado
- [x] Feedback visual (toasts, loading)
- [x] Formata√ß√£o autom√°tica de telefones
- [x] Preview de imagens
- [x] Contadores e indicadores visuais

### üöÄ Tecnologias em Uso

- [x] Next.js 15.3.3 com Turbopack
- [x] TypeScript para tipagem
- [x] Tailwind CSS para estilos
- [x] Supabase PostgreSQL
- [x] Upload de arquivos nativo
- [x] Heroicons para √≠cones

### üìÅ Estrutura Final

```
app/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ upload/
‚îÇ       ‚îî‚îÄ‚îÄ route.ts              # API gen√©rica de upload
‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îú‚îÄ‚îÄ lojas/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx              # Listagem de lojas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nova/page.tsx         # Cria√ß√£o de lojas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/editar/page.tsx  # Edi√ß√£o de lojas
‚îÇ   ‚îî‚îÄ‚îÄ produtos/
‚îÇ       ‚îî‚îÄ‚îÄ novo/page.tsx         # Cria√ß√£o de produtos (corrigido)
components/
‚îú‚îÄ‚îÄ ImageUpload.tsx               # Upload para lojas (10 imagens)
‚îî‚îÄ‚îÄ ProductImageUpload.tsx        # Upload para produtos (4 imagens)
public/uploads/
‚îú‚îÄ‚îÄ lojas/                        # Imagens de lojas
‚îî‚îÄ‚îÄ produtos/                     # Imagens de produtos
```

## üîß Corre√ß√µes Implementadas

### Sistema de Upload Expandido

- **API Unificada**: Upload funciona para lojas e produtos via par√¢metro `type`
- **Diret√≥rios Separados**: `/uploads/lojas/` e `/uploads/produtos/`
- **Nomenclatura Espec√≠fica**: `loja_timestamp.ext` e `produto_timestamp.ext`

### P√°gina de Produtos Corrigida

- ‚úÖ Substitu√≠do `ImageUpload` por `ProductImageUpload`
- ‚úÖ Corrigidas tipagens de callbacks TypeScript
- ‚úÖ Adicionada verifica√ß√£o de imagens no `handleCancel`
- ‚úÖ Criado diret√≥rio espec√≠fico `/uploads/produtos/`
- ‚úÖ Removidos imports n√£o utilizados

### Componentes de Upload

```typescript
// Para lojas (at√© 10 imagens)
<ImageUpload
  value={string}
  onChange={(url: string) => void}
  onSetAsPrincipal={() => void}
  isPrincipal={boolean}
  index={number}
/>

// Para produtos (at√© 4 imagens)
<ProductImageUpload
  images={string[]}
  principalIndex={number}
  onImagesChange={(images: string[], index: number) => void}
  onUploadError={(error: string) => void}
  onUploadSuccess={(message: string) => void}
/>
```

---

**Desenvolvido para TurattiMT**  
_Sistema completo de gerenciamento de lojas e produtos com upload de imagens_
